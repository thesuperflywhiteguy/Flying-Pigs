package thunderdome.noip.biz.FlyingPigs;

import java.util.HashMap;
import java.util.Map.Entry;

import org.bukkit.Location;
import org.bukkit.Server;
import org.bukkit.entity.Entity;
import org.bukkit.entity.EntityType;
import org.bukkit.entity.Player;
import org.bukkit.entity.Pig;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerInteractEntityEvent;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.material.Directional;
import org.bukkit.plugin.java.JavaPlugin;
import org.bukkit.util.Vector;

public final class FlyingPigs extends JavaPlugin {
	
	private final HashMap<String, Pig> pigMap = new HashMap<String, Pig>();

    @Override
    public void onEnable(){
    	Server s = getServer();
    	s.getScheduler().scheduleSyncRepeatingTask(this, new Controller (), 1, 1);
        s.getPluginManager().registerEvents(new LoginListener(), this);
    	s.getLogger().info("Daves Custom plugin enabled!");
        // TODO Insert logic to be performed when the plugin is enabled
    }
 
    @Override		
    public void onDisable() {
    	Server s = getServer();
    	//s.getScheduler().scheduleSyncRepeatingTask(this, new DragonControl(), 1L, 1L);

    	s.getLogger().info("Daves Custom plugin disabled!");
        // TODO Insert logic to be performed when the plugin is disabled
    }

	private class Controller implements Runnable{
		public void run(){
			Server s = getServer();
			  for(Entry<String, Pig> e: pigMap.entrySet()){
					String pn = e.getKey();
					
					Player player = s.getPlayerExact(pn);
					
					Pig pig = e.getValue();
					if(player == null || !player.isOnline()){
						pig.remove();
					
						pigMap.remove(pn);
						continue;
					}
					Location playerLocation= player.getEyeLocation();
					
					pig.setTarget(player);
					
					Location pigLocation = pig.getLocation();
					pigLocation.setPitch(playerLocation.getPitch());
					
					pigLocation.setYaw(playerLocation.getYaw());
					
					pig.setVelocity(pigLocation.getDirection());
			  }
		}
	}
		
	public class LoginListener implements Listener {
	    @EventHandler
	    public void playerJoin(PlayerJoinEvent event) { 
	    	getServer().getLogger().info("attempting to spawn a pig");
	    	Player player = event.getPlayer();
	    	Pig pig = (Pig) player.getWorld().spawnEntity(player.getLocation(), EntityType.PIG);
	    	pig.setSaddle(true);
	    	//pig.setPassenger(player);
	    	//pigMap.put(player.getName(), pig);
	    }

	    @EventHandler
	    public void hoppedOnAPigEvent(PlayerInteractEntityEvent event){
	    	getServer().getLogger().info("AAANNNd Right CLick");
	    	if (event.getRightClicked().getType().equals(EntityType.PIG)){
	    		Pig pig = (Pig)event.getRightClicked();
	    		if (pig.getPassenger().equals(event.getPlayer())){
	    	    	pigMap.put(event.getPlayer().getName(), pig);
	    		}
	    	}
	    }
	}
}
